# Rebuild v3 without f-string to avoid brace escaping issues
import base64

logo_path = "/mnt/data/그림1.png"
with open(logo_path, "rb") as f:
    b64 = base64.b64encode(f.read()).decode("ascii")
data_uri = f"data:image/png;base64,{b64}"

html_template = """<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>거북식당 | 주간 식단 · 뉴스 · 커뮤니티</title>
  <meta name="description" content="거북식당 — 모바일 반응형: 당일/주간 식단, 제조업·경제·사회 뉴스, 커뮤니티" />
  <style>
    /* --- Peach (logo background) theme --- */
    :root{
      --bg:#F4EDE3;
      --surface:#FFFFFF;
      --muted:#6B7280;
      --text:#1E2930;
      --line:#E5DCD0;
      --accent:#145A64;
      --accent-ink:#FFFFFF;
      --chip:#F7F2EA;
      --danger:#DC2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,system-ui,sans-serif; line-height:1.6}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    .border{border:1px solid var(--line)}
    .rounded{border-radius:14px} .rounded-xl{border-radius:18px} .rounded-2xl{border-radius:24px}
    .muted{color:var(--muted)}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:18px;padding:16px}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px;color:#475569}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--text);cursor:pointer;transition:.2s;font-weight:600}
    .btn:hover{filter:brightness(1.03)}
    .btn-accent{background:var(--accent);color:var(--accent-ink);border-color:transparent}
    .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
    .input, .select, .textarea{width:100%;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid var(--line);color:var(--text)}
    .textarea{min-height:100px;resize:vertical}

    header.sticky{position:sticky;top:0;z-index:40;background:rgba(244,237,227,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    nav a{padding:12px 10px;display:inline-block;color:#334155}
    nav a:hover{color:#111}
    .logo{display:flex;align-items:center;gap:10px}
    .logo img{height:36px;width:auto}

    h1{font-size:28px;margin:10px 0}@media(min-width:768px){h1{font-size:36px}}
    h2{font-size:22px;margin:0 0 10px}@media(min-width:768px){h2{font-size:28px}}
    h3{font-size:18px;margin:0 0 6px}

    .grid{display:grid;gap:14px}
    .g2{grid-template-columns:1fr}@media(min-width:880px){.g2{grid-template-columns:1fr 1fr}}
    .g3{grid-template-columns:1fr}@media(min-width:980px){.g3{grid-template-columns:1fr 1fr 1fr}}

    /* --- Intro banner --- */
    .intro{padding:18px 0}
    .intro .box{background:var(--surface);border:1px solid var(--line);border-radius:18px;padding:16px;display:flex;gap:14px;align-items:flex-start}
    .intro .box img{height:46px;width:auto}

    /* --- Category bar --- */
    .cats{padding:8px 0}
    .catbar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(min-width:720px){ .catbar{grid-template-columns:repeat(6,1fr)} }
    .cat{display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--line);border-radius:14px;padding:10px;min-height:66px}
    .cat span{font-weight:700;color:#0f172a}
    .cat img{height:36px;width:auto}

    /* --- Ad block --- */
    .ad-wrap{padding:8px 0}
    .ad-slot{display:flex;align-items:center;justify-content:center}
    .ad-content{width:100%;max-width:320px;height:100px;border-radius:12px;border:1px dashed #94a3b8;background:#fff;color:#64748b;
      display:flex;align-items:center;justify-content:center;font-size:12px;text-align:center;padding:6px}
    @media(min-width:980px){ .ad-content{max-width:728px;height:90px} }

    /* --- Sections --- */
    section{scroll-margin-top:84px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:8px}
    .tabs{display:flex;gap:4px;background:#fff;border:1px solid var(--line);padding:4px;border-radius:12px}
    .tab{padding:8px 12px;border-radius:8px;cursor:pointer;color:#334155}
    .tab[aria-selected="true"]{background:var(--accent);color:#fff;font-weight:700}
    .weekday{display:grid;grid-template-columns:1fr;gap:8px}@media(min-width:600px){.weekday{grid-template-columns:repeat(3,1fr)}}
    .meal{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .news-card, .post{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    footer{border-top:1px solid var(--line);padding:28px 0;margin-top:40px}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Sticky header (nav only) -->
  <header class="sticky">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;">
      <nav>
        <a href="#menu">식단</a>
        <a href="#news">NEWS</a>
        <a href="#board">커뮤니티</a>
        <a href="#voices">현장의 소리</a>
        <a href="#admin">관리</a>
      </nav>
      <div class="chip">모바일 반응형</div>
    </div>
  </header>

  <!-- 1) Top intro notice -->
  <section class="intro">
    <div class="container">
      <div class="box">
        <img src="__LOGO__" alt="거북식당 로고" />
        <div>
          <strong>거북식당 안내</strong>
          <p class="muted" style="margin:6px 0 0">
            거북식당은 <b>대기업출신 영양사</b>가 직접 영양 성분을 고려하여 식단을 구성합니다.<br/>
            거북식당과 <b>건강한 음식</b>, <b>건강한 지식</b>을 채워보세요.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- 2) Category bar -->
  <section class="cats">
    <div class="container">
      <div class="catbar">
        <a class="cat" href="#top" title="거북식당">
          <!-- 로고만 (텍스트 없음) -->
          <img src="__LOGO__" alt="거북식당 로고" />
        </a>
        <a class="cat" href="#menu"><span>식단</span></a>
        <a class="cat" href="#news"><span>NEWS</span></a>
        <a class="cat" href="#board"><span>커뮤니티</span></a>
        <a class="cat" href="#voices"><span>현장의 소리</span></a>
        <a class="cat" href="#admin"><span>관리</span></a>
      </div>
    </div>
  </section>

  <!-- 3) Ad banner block -->
  <section class="ad-wrap">
    <div class="container ad-slot">
      <div class="ad-content">
        광고 배너 영역 — Mobile 320×100 / Desktop 728×90<br/>
        <span style="opacity:.7">광고 코드를 삽입하면 이 박스가 대체됩니다.</span>
      </div>
    </div>
  </section>

  <!-- 4) 바로 '오늘 식단' 시작 (로고 배너 없음) -->
  <section id="menu" class="container" style="margin-top:10px">
    <div class="toolbar">
      <div class="tabs" role="tablist" aria-label="식단 탭">
        <button class="tab" id="tab-today" role="tab" aria-selected="true">오늘 식단</button>
        <button class="tab" id="tab-week" role="tab" aria-selected="false">이번 주</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="muted" id="weekLabel"></span>
        <button class="btn" id="prevWeek" title="이전 주">&larr;</button>
        <button class="btn" id="nextWeek" title="다음 주">&rarr;</button>
      </div>
    </div>

    <div id="panel-today" role="tabpanel">
      <div class="grid g2">
        <div class="card">
          <h2 id="todayTitle">오늘 식단</h2>
          <div class="weekday" id="todayMeals"></div>
        </div>
        <div class="card">
          <h3>알레르기/영양 안내</h3>
          <p class="muted">원산지·알레르기 정보는 각 메뉴 옆에 아이콘으로 표기됩니다.
            <span class="chip">🌶 맵기</span> <span class="chip">🥜 견과류</span> <span class="chip">🥛 유제품</span> <span class="chip">🟢 채식</span></p>
        </div>
      </div>
    </div>

    <div id="panel-week" role="tabpanel" class="hidden">
      <div class="grid g3" id="weekGrid"></div>
    </div>
  </section>

  <!-- NEWS -->
  <section id="news" class="container" style="margin-top:34px">
    <div class="toolbar">
      <h2 style="margin:0">NEWS — 제조업 · 경제 · 사회</h2>
      <div style="display:flex;gap:8px">
        <select id="newsFilter" class="select" style="max-width:180px">
          <option value="all">전체</option>
          <option value="제조업">제조업</option>
          <option value="경제">경제</option>
          <option value="사회">사회</option>
        </select>
        <input id="newsSearch" class="input" placeholder="키워드 검색" style="max-width:220px"/>
      </div>
    </div>
    <div class="grid g3" id="newsList"></div>
    <div class="card muted" style="margin-top:8px">
      팁: 뉴스는 운영자가 <b>링크와 제목</b>을 추가하는 방식으로 관리됩니다(클릭 수 집계). 외부 크롤링은 포함하지 않았습니다.
    </div>
  </section>

  <!-- BOARD (커뮤니티) -->
  <section id="board" class="container" style="margin-top:34px">
    <div class="toolbar">
      <h2 style="margin:0">커뮤니티</h2>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="boardSearch" class="input" placeholder="검색 (제목/내용/닉네임)" style="max-width:240px"/>
        <select id="boardFilter" class="select" style="max-width:160px">
          <option value="all">전체</option>
          <option value="현장노하우">현장노하우</option>
          <option value="장비/공구">장비/공구</option>
          <option value="일상잡담">일상잡담</option>
        </select>
      </div>
    </div>

    <div class="grid g2">
      <div class="card">
        <h3>글쓰기</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <input id="nick" class="input" placeholder="닉네임"/>
          <select id="cat" class="select">
            <option>현장노하우</option>
            <option>장비/공구</option>
            <option>일상잡담</option>
          </select>
        </div>
        <input id="title" class="input" placeholder="제목" style="margin-top:8px"/>
        <textarea id="body" class="textarea" placeholder="내용을 입력하세요."></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="clearForm">초기화</button>
          <button class="btn btn-accent" id="submitPost">등록</button>
        </div>
      </div>

      <div class="card">
        <h3>최근 글</h3>
        <div id="postList" class="grid"></div>
      </div>
    </div>
  </section>

  <!-- 현장의 소리: 커뮤니티 중 '현장노하우' 카테고리 하이라이트 -->
  <section id="voices" class="container" style="margin-top:34px">
    <div class="toolbar">
      <h2 style="margin:0">현장의 소리</h2>
      <p class="muted">커뮤니티의 <b>현장노하우</b> 카테고리에서 최근 글 3개를 자동으로 보여줍니다.</p>
    </div>
    <div id="voicesList" class="grid g3"></div>
  </section>

  <!-- Admin -->
  <section id="admin" class="container" style="margin-top:34px">
    <div class="card">
      <h2>관리자 · 데이터 관리</h2>
      <details>
        <summary>주간 식단 입력/수정</summary>
        <div class="muted" style="margin:6px 0 10px">해당 주의 식단을 입력하면 브라우저에 저장됩니다(로컬스토리지). 다른 사람과 공유하려면 사이트에 올린 뒤 JSON을 내보내 전송하세요.</div>
        <div class="grid g2">
          <div>
            <label class="muted">주 시작 날짜(월요일 기준)</label>
            <input type="date" id="weekStart" class="input"/>
          </div>
          <div>
            <label class="muted">식사(조/중/석)·요일별 입력</label>
            <select id="mealSelect" class="select">
              <option value="breakfast">조식</option>
              <option value="lunch">중식</option>
              <option value="dinner">석식</option>
            </select>
          </div>
        </div>
        <div class="grid g3" style="margin-top:8px" id="editDays"></div>
        <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
          <button class="btn" id="resetWeek">주 초기화</button>
          <button class="btn btn-accent" id="saveWeek">저장</button>
        </div>
      </details>

      <details style="margin-top:16px">
        <summary>NEWS 추가/관리</summary>
        <div class="grid g2">
          <input id="newsTitle" class="input" placeholder="기사 제목"/>
          <input id="newsUrl" class="input" placeholder="링크(https://)"/>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="newsCat" class="select">
            <option>제조업</option>
            <option>경제</option>
            <option>사회</option>
          </select>
          <button class="btn btn-accent" id="addNews">추가</button>
          <button class="btn" id="exportNews">뉴스 JSON 내보내기</button>
          <button class="btn" id="importNews">가져오기</button>
        </div>
      </details>

      <details style="margin-top:16px">
        <summary>백업 · 초기화</summary>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="exportAll">모든 데이터 내보내기</button>
          <button class="btn" id="importAll">불러오기</button>
          <button class="btn btn-danger" id="wipeAll">전체 초기화</button>
        </div>
      </details>
    </div>
  </section>

  <footer>
    <div class="container">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="__LOGO__" alt="거북식당 로고" style="height:22px;width:auto"/>
        <strong>거북식당</strong>
      </div>
      <div class="muted" style="margin-top:6px">© <span id="year"></span> Geobuk Dining — 모바일 반응형 식단·커뮤니티</div>
    </div>
  </footer>

  <script>
  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtDate = d => new Date(d).toLocaleDateString('ko-KR', {month:'short', day:'numeric'});
  const today = new Date();
  const MON = d => {const n = new Date(d); const day=(n.getDay()+6)%7; n.setHours(0,0,0,0); n.setDate(n.getDate()-day); return n;}
  const weekKey = d => {const m=MON(d); return m.toISOString().slice(0,10)}; // YYYY-MM-DD (Mon)

  // ---------- Storage ----------
  const storage = {
    get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch(e){ return fallback } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  // ---------- Sample Data ----------
  const SAMPLE_WEEK = (start) => {
    const labels = ['월','화','수','목','금','토','일'];
    const menu = { };
    for(let i=0;i<7;i++){ menu[i]={ breakfast:['현미밥','미소된장국','계란말이','김치','두유'], lunch:['쌀밥','갈비찜','계절나물','김치','과일'], dinner:['잡곡밥','닭가슴살구이','샐러드','김치','요거트'] }; }
    menu[2].lunch.push('비건두부구이 🟢'); menu[4].lunch.push('매운돼지볶음 🌶');
    return { startISO:start.toISOString(), labels, menu };
  };

  // ---------- Menu Model ----------
  const MENU_DB_KEY = 'geobuk.menu';
  const ALL_MENU = storage.get(MENU_DB_KEY, {});
  function ensureWeek(d){ const key = weekKey(d); if(!ALL_MENU[key]) ALL_MENU[key] = SAMPLE_WEEK(MON(d)); return key; }

  // ---------- News Model ----------
  const NEWS_KEY = 'geobuk.news';
  const NEWS = storage.get(NEWS_KEY, [
    {title:'국내 설비투자 반등 조짐', url:'https://example.com/a', cat:'경제', ts:Date.now()-86400000*2, clicks:0},
    {title:'반도체 공정 혁신 사례', url:'https://example.com/b', cat:'제조업', ts:Date.now()-86400000*1, clicks:0},
    {title:'출퇴근 개선, 시차출근제 확대', url:'https://example.com/c', cat:'사회', ts:Date.now()-86400000*3, clicks:0}
  ]);

  // ---------- Board Model ----------
  const BOARD_KEY = 'geobuk.board';
  const BOARD = storage.get(BOARD_KEY, []);

  // ---------- Menu UI ----------
  let currentWeekKey = ensureWeek(today);
  function setWeekLabel(){ const start = new Date(currentWeekKey); const end = new Date(start); end.setDate(start.getDate()+6); $('#weekLabel').textContent = fmtDate(start) + ' ~ ' + fmtDate(end); }

  function renderToday(){
    const wk = ALL_MENU[currentWeekKey]; if(!wk) return;
    const dow = (new Date().getDay()+6)%7; const labels = ['월','화','수','목','금','토','일'];
    $('#todayTitle').textContent = `오늘 식단 — ${labels[dow]}요일`;
    const meals = wk.menu[dow]; const wrap = $('#todayMeals'); wrap.innerHTML='';
    const groups = [['조식','breakfast'],['중식','lunch'],['석식','dinner']];
    for(const [label,key] of groups){ const list = meals[key]||[]; const box = document.createElement('div'); box.className='meal';
      box.innerHTML = `<h4>${label}</h4><div class="muted" style="font-size:14px">${list.length?list.join(' · '):'등록된 메뉴가 없습니다.'}</div>`; wrap.appendChild(box); }
  }

  function renderWeek(){
    const wk = ALL_MENU[currentWeekKey]; if(!wk) return;
    const labels = wk.labels; const grid = $('#weekGrid'); grid.innerHTML='';
    for(let i=0;i<7;i++){ const day = new Date(currentWeekKey); day.setDate(day.getDate()+i);
      const card = document.createElement('div'); card.className='card';
      const meals = wk.menu[i]; const isToday = weekKey(today)===currentWeekKey && ((today.getDay()+6)%7)===i;
      card.innerHTML = `<h3>${labels[i]}요일 ${isToday?'<span class="chip" style="margin-left:6px;background:var(--accent);color:#fff">오늘</span>':''}</h3>
        <div class="meal"><h4>조식</h4><div class="muted">${(meals.breakfast||[]).join(' · ')||'—'}</div></div>
        <div class="meal" style="margin-top:6px"><h4>중식</h4><div class="muted">${(meals.lunch||[]).join(' · ')||'—'}</div></div>
        <div class="meal" style="margin-top:6px"><h4>석식</h4><div class="muted">${(meals.dinner||[]).join(' · ')||'—'}</div></div>`;
      grid.appendChild(card);
    }
  }

  // Tabs
  $('#tab-today').addEventListener('click', ()=>{ $('#tab-today').setAttribute('aria-selected','true'); $('#tab-week').setAttribute('aria-selected','false'); $('#panel-today').classList.remove('hidden'); $('#panel-week').classList.add('hidden'); renderToday(); });
  $('#tab-week').addEventListener('click', ()=>{ $('#tab-week').setAttribute('aria-selected','true'); $('#tab-today').setAttribute('aria-selected','false'); $('#panel-week').classList.remove('hidden'); $('#panel-today').classList.add('hidden'); renderWeek(); });

  // Week navigation
  $('#prevWeek').addEventListener('click', ()=>{ const s=new Date(currentWeekKey); s.setDate(s.getDate()-7); currentWeekKey=ensureWeek(s); setWeekLabel(); renderWeek(); renderToday(); });
  $('#nextWeek').addEventListener('click', ()=>{ const s=new Date(currentWeekKey); s.setDate(s.getDate()+7); currentWeekKey=ensureWeek(s); setWeekLabel(); renderWeek(); renderToday(); });

  // ---------- Admin: Menu editing ----------
  function buildEditGrid(){
    const wrap = $('#editDays'); wrap.innerHTML=''; const labels=['월','화','수','목','금','토','일'];
    for(let i=0;i<7;i++){ const c=document.createElement('div'); c.className='card';
      c.innerHTML = `<strong>${labels[i]}요일</strong>
        <label class="muted" style="display:block;margin-top:6px">메뉴(콤마로 구분)</label>
        <input class="input" id="ed_${i}" placeholder="예: 쌀밥, 미소국, 제육볶음, 김치"/>`; wrap.appendChild(c); }
  }
  buildEditGrid();

  function loadEditFields(){ const wk=ALL_MENU[currentWeekKey]; if(!wk) return; const mealKey = $('#mealSelect').value;
    for(let i=0;i<7;i++){ const list = (wk.menu[i][mealKey]||[]).join(', '); $('#ed_'+i).value = list; } }

  $('#mealSelect').addEventListener('change', loadEditFields);
  $('#weekStart').addEventListener('change', e=>{ const d = new Date(e.target.value); const m = MON(d); currentWeekKey = ensureWeek(m); setWeekLabel(); renderWeek(); renderToday(); loadEditFields(); });

  $('#saveWeek').addEventListener('click', ()=>{ const wk=ALL_MENU[currentWeekKey]; const mealKey=$('#mealSelect').value;
    for(let i=0;i<7;i++){ const v = $('#ed_'+i).value.trim(); wk.menu[i][mealKey] = v? v.split(',').map(s=>s.trim()).filter(Boolean) : []; }
    storage.set(MENU_DB_KEY, ALL_MENU); alert('저장되었습니다.'); renderToday(); renderWeek(); });

  $('#resetWeek').addEventListener('click', ()=>{ if(!confirm('해당 주의 식단을 비웁니다. 계속할까요?')) return; const wk=ALL_MENU[currentWeekKey];
    for(let i=0;i<7;i++){ wk.menu[i]={breakfast:[],lunch:[],dinner:[]}; } storage.set(MENU_DB_KEY, ALL_MENU); loadEditFields(); renderToday(); renderWeek(); });

  // ---------- News ----------
  function renderNews(){
    const filter = $('#newsFilter').value; const q = $('#newsSearch').value.toLowerCase(); const box = $('#newsList'); box.innerHTML='';
    NEWS.slice().sort((a,b)=>b.ts-a.ts).filter(n=> (filter==='all'||n.cat===filter) && (n.title.toLowerCase().includes(q))).forEach(n=>{
        const card=document.createElement('div'); card.className='news-card';
        const date=new Date(n.ts).toLocaleDateString('ko-KR');
        card.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div><a href="${n.url}" target="_blank" rel="noopener">${n.title}</a><div class="muted" style="font-size:12px">${n.cat} · ${date} · 조회 ${n.clicks||0}</div></div>
            <span class="chip">${n.cat}</span>
          </div>`;
        card.querySelector('a').addEventListener('click',()=>{ n.clicks=(n.clicks||0)+1; storage.set(NEWS_KEY, NEWS); renderNews(); });
        box.appendChild(card);
      });
  }
  $('#newsFilter').addEventListener('change', renderNews);
  $('#newsSearch').addEventListener('input', renderNews);
  $('#addNews').addEventListener('click', ()=>{
    const t=$('#newsTitle').value.trim(), u=$('#newsUrl').value.trim(), c=$('#newsCat').value;
    if(!t||!u){ alert('제목과 링크를 입력하세요.'); return; }
    NEWS.push({title:t,url:u,cat:c,ts:Date.now(),clicks:0});
    storage.set(NEWS_KEY, NEWS);
    $('#newsTitle').value=''; $('#newsUrl').value=''; renderNews();
  });
  $('#exportNews').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(NEWS,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='news.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#importNews').addEventListener('click',()=>{
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=e=>{ const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); NEWS.splice(0,NEWS.length,...data); storage.set(NEWS_KEY,NEWS); renderNews(); }catch(e){ alert('JSON 형식이 아닙니다.'); } };
      r.readAsText(f);
    }; input.click();
  });

  // ---------- Board ----------
  function renderBoard(){
    const q = $('#boardSearch').value.toLowerCase();
    const f = $('#boardFilter').value;
    const box = $('#postList'); box.innerHTML='';
    BOARD.slice().sort((a,b)=>b.ts-a.ts).filter(p=> (f==='all'||p.cat===f) && (p.title+p.body+p.nick).toLowerCase().includes(q)).forEach(p=>{
        const div=document.createElement('div'); div.className='post';
        const date=new Date(p.ts).toLocaleString('ko-KR');
        div.innerHTML = `<div class="muted" style="font-size:12px">${p.cat} · ${p.nick} · ${date}</div>
          <strong>${p.title}</strong>
          <p style="white-space:pre-wrap;margin:6px 0 0">${p.body}</p>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" data-like="${p.id}">공감 👍 <span>${p.likes||0}</span></button>
            <button class="btn" data-del="${p.id}">삭제</button>
          </div>`;
        div.querySelector('[data-like]').addEventListener('click',()=>{ p.likes=(p.likes||0)+1; storage.set(BOARD_KEY, BOARD); renderBoard(); });
        div.querySelector('[data-del]').addEventListener('click',()=>{ if(!confirm('이 글을 삭제할까요?')) return;
          const idx=BOARD.findIndex(x=>x.id===p.id); if(idx>-1){ BOARD.splice(idx,1); storage.set(BOARD_KEY, BOARD); renderBoard(); } });
        box.appendChild(div);
      });
  }
  $('#submitPost').addEventListener('click',()=>{
    const nick=$('#nick').value.trim()||'익명', cat=$('#cat').value, title=$('#title').value.trim(), body=$('#body').value.trim();
    if(!title||!body){ alert('제목과 내용을 입력하세요.'); return; }
    BOARD.push({id:crypto.randomUUID(), nick, cat, title, body, ts:Date.now(), likes:0});
    storage.set(BOARD_KEY, BOARD);
    $('#title').value=''; $('#body').value=''; renderBoard(); renderVoices();
  });
  $('#clearForm').addEventListener('click',()=>{ $('#title').value=''; $('#body').value=''; });
  $('#boardSearch').addEventListener('input', renderBoard);
  $('#boardFilter').addEventListener('change', renderBoard);

  // ---------- Voices (현장노하우 하이라이트) ----------
  function renderVoices(){
    const box = $('#voicesList'); if(!box) return; box.innerHTML='';
    const pick = BOARD.filter(p=>p.cat==='현장노하우').slice().sort((a,b)=>b.ts-a.ts).slice(0,3);
    if(pick.length===0){ box.innerHTML = '<div class="muted">아직 게시물이 없습니다. 커뮤니티에 글을 남겨주세요.</div>'; return; }
    pick.forEach(p=>{
      const d=document.createElement('div'); d.className='news-card';
      const date=new Date(p.ts).toLocaleDateString('ko-KR');
      d.innerHTML = `<strong>${p.title}</strong><div class="muted" style="font-size:12px">${p.nick} · ${date}</div>
        <p style="white-space:pre-wrap;margin:6px 0 0">${(p.body||'').slice(0,120)}${(p.body||'').length>120?'…':''}</p>`;
      box.appendChild(d);
    });
  }

  // ---------- Backup / Restore ----------
  $('#exportAll').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify({ALL_MENU, NEWS, BOARD}, null, 2)], {type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='geobuk_backup.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#importAll').addEventListener('click',()=>{
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=e=>{ const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ try{
        const data=JSON.parse(r.result);
        Object.assign(ALL_MENU, data.ALL_MENU||{});
        NEWS.splice(0,NEWS.length, ...(data.NEWS||[]));
        BOARD.splice(0,BOARD.length, ...(data.BOARD||[]));
        storage.set(MENU_DB_KEY, ALL_MENU); storage.set(NEWS_KEY, NEWS); storage.set(BOARD_KEY, BOARD);
        setWeekLabel(); renderToday(); renderWeek(); renderNews(); renderBoard(); loadEditFields(); renderVoices();
      }catch(e){ alert('JSON 형식이 아닙니다.'); } };
      r.readAsText(f);
    }; input.click();
  });
  $('#wipeAll').addEventListener('click',()=>{
    if(!confirm('모든 데이터를 초기화합니다. 계속할까요?')) return;
    localStorage.removeItem(MENU_DB_KEY); localStorage.removeItem(NEWS_KEY); localStorage.removeItem(BOARD_KEY);
    location.reload();
  });

  // ---------- Init ----------
  document.getElementById('year').textContent = new Date().getFullYear();
  function initWeek(){ const k = ensureWeek(new Date()); currentWeekKey = k; setWeekLabel(); renderToday(); renderWeek(); loadEditFields(); }
  initWeek(); renderNews(); renderBoard(); renderVoices();
  </script>
</body>
</html>
"""

html = html_template.replace("__LOGO__", data_uri)
out_path = "/mnt/data/geobuk_index_v3.html"
with open(out_path, "w", encoding="utf-8") as f:
    f.write(html)

out_path
